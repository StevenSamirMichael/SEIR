<html>

<head>
    <title>Yet Another COVID-919 SEIR Calculator</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <style>
        .bar {
            fill: lightsteelblue;
        }

        .bar[myhover] {
            fill: steelblue;
        }

        .axis-label {
            font: 20px sans-serif;
            fill: steelblue;
        }

        .myradio {
            font-family: sans-serif;
            font-size: 15px;
            color: darkslategray;
        }

        .axis {
            font: 16px sans-serif;
            color: lightslategrey;
        }

        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
            stroke-width: 0.5;
        }

        .grid path {
            stroke-width: 0;
        }

        .minorTitle {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            margin: auto;
            display: flex;
            width: 950px;
            font-size: 17px;
            color: #666;
        }

        .minorTitleColumn {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            flex: 60px;
            padding: 3px;
            border-bottom: 2px solid #999;
        }

        select[disabled=true] {
            color: #ccc;
            background-color: #eee;
        }

        .notestext {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            font-size: 14px;
            color: darkslategrey;
            padding-top: 8px;
        }

        .loctext {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            font-size: 14px;
            color: darkslategrey;
            padding-top: 20px;
        }

        .h2 {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            font-size: 24px;
            color: darkslategray;
            padding: 3px;
            flex: 60px;
            padding-left: 10px;
            padding-bottom: 30px;
        }

        .column {
            float: left;
            width: 770px;
            padding: 10px;
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }
    </style>
</head>

<body>
    <div class="h2">
        Yet Another COVID-19 SEIR Model
    </div>
    <div class="row">
        <div class="column">
            <div>
                <div class="MinorTitleColumn">Location</div>
                <table width="100%" style="padding-top: 10px;table-layout: fixed;">
                    <tr>
                        <td><label class="myradio">
                                <input type="radio" name="sourcetype" value="radio_country" checked>Country</input>
                            </label>
                        </td>
                        <td><label class="myradio">
                                <input type="radio" name="sourcetype" value="radio_states">US States</input>
                            </label>
                        </td>
                        <td><label class="myradio">
                                <input type="radio" name="sourcetype" value="radio_special">Special</input>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding-top: 10px;">
                            <div id="countries"></div>
                        </td>
                        <td style="padding-top: 10px;">
                            <div id="states"></div>
                        </td>
                        <td>
                            <div id="special"></div>
                        </td>
                    </tr>
                </table>
            </div>

            <div>
                <table style="padding-top: 10px" cellspacing="10">
                    <tr>
                        <td align="right">Population: </td>
                        <td align="left" id="namefield"></td>
                    </tr>
                    <tr>
                        <td align="right">Date: </td>
                        <td align="left" id="deathsdate"></td>
                    </tr>
                    <tr>
                        <td align="right">Deaths: </td>
                        <td align="left" id="deathsfield"></td>
                    </tr>
                    <tr>
                        <td align="right">Confirmed Cases: </td>
                        <td align="left" id="casesfield"></td>
                    </tr>
                </table>
            </div>

            <div class="loctext" id="namefield"></div>
        </div>
        <div class="column">
            <div>
                <div class="MinorTitleColumn">SEIR Model Parameters</div>
                <div class="notestext" style="font-style: italic">
                    Coming Soon...
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="column">
            <div class="MinorTitleColumn">Deaths</div>
            <div id="deaths_plot"></div>
        </div>
        <div class="column">
            <div class="MinorTitleColumn">Confirmed Cases</div>
            <div id="cases_plot"></div>
        </div>
    </div>
    <div class="row">
        <div class=column>
            <div class="MinorTitleColumn" style="width: 1550px;">Notes</div>
            <div class="notestext">
                Data source: Johns Hopkins Coronavirus Research Center: <a
                    href="https://github.com/CSSEGISandData/COVID-19">https://github.com/CSSEGISandData/COVID-19</a>
            </div>
            <div id="author" class="notestext">
                <table class="notestext">
                    <tr>
                        <td>Author:</td>
                        <td>Steven Michael <a href="mailto:ssmichael@gmail.com">ssmichael@gmail.com</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><a href="https://github.com/StevenSamirMichael/">https://github.com/StevenSamirMichael/</a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</body>


<script src="/js/d3/dist/d3.min.js"></script>
<script src="js/moment/min/moment.min.js"></script>
<script src="js/mathjax/es5/tex-mml-chtml.js"></script>

<script>

    var plot_width = 750;
    var plot_height = 400;
    var svg = d3.select("#deaths_plot")
        .attr("width", plot_width)
        .append("svg")
        .attr("width", plot_width)
        .attr("height", plot_height)
    //.attr('viewBox', '0 0 '+ width * 1.1 + ' ' + height * 1.2)
    //.attr('preserveAspectRatio', 'xMinYMin');
    var margin = {
        top: 20,
        right: 30,
        bottom: 30,
        left: 100
    };
    var width = +svg.attr("width") - margin.left - margin.right
    var height = +svg.attr("height") - margin.top - margin.bottom;

    // Main group holding the deaths plot
    var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .attr("width", width)
        .attr("height", height);


    // SVG for the confirmed cases plot
    var svg2 = d3.select("#cases_plot").append("svg")
        .attr("width", plot_width)
        .attr("height", plot_height)

    width = +svg.attr("width") - margin.left - margin.right
    height = +svg.attr("height") - margin.top - margin.bottom;

    // Main group holding the confirmed cases plot
    var g2 = svg2.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    // Functions to scale axes
    var x = d3.scaleBand()
        .rangeRound([0, width])
        .padding(0.1);

    var y = d3.scaleLinear()
        .rangeRound([height, 0]);

    // Get a list of states
    const baseurl = window.location.origin;
    d3.json(baseurl + "/data/statelist").then(function (stateslist) {
        var s = d3.select("#states")
            .insert("select")
        s
            .attr("id", "states_dropdown")
            .attr("disabled", true)
            .selectAll("option")
            .data(stateslist)
            .enter()
            .append("option")
            .attr("value", d => d)
            .text(d => d);
        s.on("change", () => {
            UpdatePlotState(s.property("value"));
        });

    });
    d3.json(baseurl + "/data/countrylist").then(function (countrylist) {
        var s = d3.select("#countries")
            .insert("select")

        s
            .attr("id", "countries_dropdown")
            .selectAll("option")
            .data(countrylist)
            .enter()
            .append("option")
            .attr("value", d => d)
            .text(d => d);
        s.on("change", () => {
            UpdatePlotCountry(s.property("value"));
        });
    });

    d3.selectAll("input[name='sourcetype']").on("change", function (d) {
        console.log(this.value);
        var cntry = d3.selectAll("#countries_dropdown");
        var states = d3.selectAll("#states_dropdown");
        if (this.value == "radio_states") {
            cntry.attr("disabled", true);
            states.attr("disabled", null);
            UpdatePlotState(states.property("value"));
        }
        else if (this.value == "radio_country") {
            cntry.attr("disabled", null);
            states.attr("disabled", true);
            UpdatePlotCountry(cntry.property("value"));
        }
    });

    function UpdatePlotState(statename) {
        d3.json(baseurl + "/data/state/" + statename).then(d => updatePlots(d));
    }
    function UpdatePlotCountry(countryname) {
        d3.json(baseurl + "/data/country/" + countryname).then(d => updatePlots(d));
    }

    function updatePlots(data) {
        updatePlot(g, g2, data, "COVID-19 Related Deaths", "deaths");
        updatePlot(g2, g, data, "COVID-19 Confirmed Cases", "confirmed");
        d3.select("#namefield").text(data.population);
        d3.select("#deathsfield").html("");
        d3.select("#casesfield").html("");
    }

    function updatePlot(grp, grp2, alldata, titlestring, fieldname) {
        // re-draw plot
        grp.selectAll('*').remove();

        var name = alldata['name'];
        var data = alldata['series'];

        // Remove data before March 1
        // (months are zero based in moment)
        mindate = moment([2020, 2, 1]);
        data = data.filter(d => { return (moment(d.date) > mindate); });

        x.domain(data.map(function (d) {
            return moment(d.date)
        }));
        y.domain([0, d3.max(data, function (d) {
            return d[fieldname];
        })]);


        // gridlines in y axis function
        function make_y_gridlines() {
            return d3.axisLeft(y)
                .ticks(10)
        }

        // add the Y gridlines
        grp.append("g")
            .attr("class", "grid")
            .call(make_y_gridlines()
                .tickSize(-width)
                .tickFormat("")
            )
        grp.append("g")
            .attr("transform", "translate(0," + height + ")")
            .attr("class", "axis")
            .call(d3.axisBottom(x)
                .tickFormat(d => { return d.get("month") + 1 + "/" + d.get("date") })
                .tickValues(x.domain().filter(function (d, i) { return !(d.dayOfYear() % 7) }))
                .ticks(4));

        var yaxis = grp.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y));

        yaxis
            .append("text")
            .attr("class", "axis-label")
            //.attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("dx", "1.0em")
            .attr("text-anchor", "start")
            .text(titlestring)
        var namelabel = yaxis
            .append("text")
            .attr("class", "axis-label")
            .attr("y", 6)
            .attr("dy", "1.8em")
            .attr("dx", "1.0em")
            .attr("text-anchor", "start")
            .text("Alabama");
        grp.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("date", function (d) { return d.date; })
            .attr("x", function (d) {
                return x(moment(d.date));
            })
            .attr("y", function (d) {
                return y(d[fieldname]);
            })
            .attr("width", x.bandwidth())
            .attr("height", function (d) {
                return height - y(Number(d[fieldname]));
            })
            .on("mouseover", function (d, i) {
                d3.select(this).attr("myhover", true);

                // Highlight same date in other plot
                grp2.selectAll(".bar")
                    .filter(function (d2) {
                        return (d2.date == d.date);
                    })
                    .attr("myhover", true);
                var deltaDeaths = 0;
                var deltaConfirmed = 0;
                if (i > 0) {
                    deltaDeaths = data[i].deaths - data[i - 1].deaths;
                    deltaConfirmed = data[i].confirmed - data[i - 1].confirmed;
                }

                console.log(deltaDeaths)
                // Update statistics text
                var dm = moment(d.date);
                d3.select("#deathsdate").html(String(dm.month() + 1).padStart(2, '0') + "/" + String(dm.date()).padStart(2, '0'));
                d3.select("#deathsfield").html("&#8721  " + d.deaths + "  ( " + (d.deaths / alldata.population * 100.0).toPrecision(2) + "% )" + "<br>&#x394 " + deltaDeaths);
                d3.select("#casesfield").html("&#8721  " + d.confirmed + "  ( " + (d.confirmed / alldata.population * 100.0).toPrecision(2) + "% )" + "<br>&#x394 " + deltaConfirmed);
            })
            .on("mouseout", function (d) {
                d3.select(this).attr("myhover", null);

                // Highlight same date in other plot
                grp2.selectAll(".bar")
                    .filter(function (d2) {
                        return (d2.date == d.date);
                    })
                    .attr("myhover", null);
            });
        namelabel.text(name);
    };
    // Default
    UpdatePlotCountry("United States")
</script>

</html>