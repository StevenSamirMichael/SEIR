<html>

<head>
    <title>Yet Another COVID-919 SEIR Calculator</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="author" content="Steven Michael">
    <meta name="keywords" content="COVID,COVID19,COVID-19,Coronavirus,SEIR,SIR,Model,ModelFitting">
    <meta name="description" content="Fit SEIR model to Johns Hopkins COVID-19 Database">
    <style>
        *,
        html,
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box !important;
            ;
        }

        body {
            padding-left: 20px;
            padding-right: 20px;
        }



        .bar {
            fill: lightsteelblue;
            shape-rendering: geometricPrecision;
        }

        .seirarea {
            fill: salmon;
            fill-opacity: 0.2;
        }

        .bar[myhover] {
            fill: steelblue;
        }

        .seir-slider {
            font: 29px sans-serif;
        }

        .intervention-label {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            font-size: 14px;
            fill: darkslategrey;
        }

        .intervention-rect {
            fill: #eeeeee
        }

        .axis-label {
            font: 14px sans-serif;
            fill: steelblue;
        }

        .myradio {
            font-family: sans-serif;
            font-size: 12px;
            color: darkslategray;
        }

        .axis {
            font: 14px sans-serif;
            color: lightslategrey;
        }

        .xaxis-title {
            font: 14px sans-serif;
            fill: lightslategrey;
        }

        .seir-slider text {
            font-size: 12px;
        }

        .x-axis {
            font: 14px sans-serif;
            color: lightslategrey;
        }

        .y-axis {
            font: 14px sans-serif;
            color: lightslategrey;
        }

        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
            stroke-width: 0.5;
        }

        .grid path {
            stroke-width: 0;
        }

        .minorTitle {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            margin-left: 0px;
            padding-left: 0px;
            width: 100%;
            font-size: 18px;
            color: #666;
        }

        .minorTitleColumn {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            border-bottom: 2px solid #999;
        }

        .paramcolumn {
            font-family: nyt-franklin, helvetica, arial, sans-sarif;
            padding-top: 20px;
            margin-left: 10px;
            margin-right: 10px;
            border-bottom: 2px solid #999
        }

        select {
            font-size: 9px;
        }

        select[disabled=true] {
            color: #ccc;
            background-color: #eee;
        }

        .notestext {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            font-size: 14px;
            color: darkslategrey;
            padding-top: 8px;
        }

        .loctext {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            font-size: 14px;
            color: darkslategrey;
            padding-top: 20px;
        }

        .h2 {
            font-family: nyt-franklin, helvetica, arial, sans-serif;
            font-size: 24px;
            color: darkslategray;
            padding: 3px;
            flex: 60px;
            padding-left: 10px;
            padding-bottom: 30px;
        }



        /* Clear floats after the columns */
        .row {
            margin: 0px;
            padding: 0px;
        }

        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        .column {
            float: left;
            padding-left: 20px;
            padding-right: 0px;
            margin: 0;
        }

        .left {
            width: 26%;
        }

        .rightsplit {
            width: 37%;
        }

        .right {
            width: 74%;
        }

        .fullwidth {
            width: 100%;
        }
    </style>
</head>

<body>

    <!-- "Title Block" -->
    <div class="row">
        <div class="h2 column third">
            Yet Another COVID-19 SEIR Model
            <div style="font-size: 14px;">(with overlay on reported statistics)</div>
        </div>
    </div>

    <!-- Data Block -->
    <div class="row">
        <div class="column fullwidth">
            <div class="MinorTitleColumn" style="font-size: 18px;">Reported COVID-19 Statistics from Johns Hopkins
                University</div>
        </div>
    </div>
    <div class="row notestext" style="padding-left: 20px;padding-right: 20px;padding-top: 20px;">
        <div class="column left">
            <div class="MinorTitleColumn">Location</div>
            <div class="row" style="padding-top: 10px;">
                <div class="column" style="width: 50%;">
                    <input type="radio" name="sourcetype" value="radio_country" checked>&nbsp Country</input>

                </div>
                <div class="column" style="width: 50%;">
                    <input type="radio" name="sourcetype" value="radio_states">&nbsp US States</input>
                </div>

            </div>
            <div class="row" style="padding-top: 10px;">
                <div class="column" style="width: 50%;">
                    <div id="countries"></div>
                </div>
                <div class="column" style="width: 50%;">
                    <div id="states"></div>
                </div>

            </div>


            <div>
                <table style="padding-top: 10px" cellspacing="10">
                    <tr>
                        <td align="right">Population: </td>
                        <td align="left" id="namefield"></td>
                    </tr>
                    <tr>
                        <td align="right">Date: </td>
                        <td align="left" id="deathsdate"></td>
                    </tr>
                    <tr>
                        <td align="right">Deaths: </td>
                        <td align="left" id="deathsfield"></td>
                    </tr>
                    <tr>
                        <td align="right">Confirmed Cases: </td>
                        <td align="left" id="casesfield"></td>
                    </tr>
                </table>
            </div>

            <div style="padding-top: 20px;">
                <input type="checkbox" name="plot_deltas">&nbsp Plot Daily Change instead of Cumulative
            </div>
            <div style="padding-top: 10px;">
                <input type="checkbox" name="overlay_model">&nbsp Overlay SEIR Model
            </div>

        </div>

        <div class="column rightsplit">
            <div class="MinorTitleColumn">Deaths</div>
            <div id="deaths_plot"></div>
        </div>
        <div class="column rightsplit">
            <div class="MinorTitleColumn">Confirmed Cases</div>
            <div id="cases_plot"></div>
        </div>
    </div>
    <!-- end of data block -->


    <!-- SEIR Model Block -->
    <div class="row">

        <!-- SEIR Model Parameters Set -->
        <div class="column fullwidth" id="modelparams">
            <div class="MinorTitleColumn" style="font-size: 18px;">SEIR Model Parameters</div>
        </div>
        <!-- END of SEIR Model Parameter Sensors-->

    </div>


    <div class="row">
        <!-- START of SEIR Plot-->
        <div class="column fullwidth" style="padding-bottom: 20px;">
            <div class="MinorTitleColumn" style="font-size: 18px;">SEIR Model Plot</div>
            <div class="row" sytle="width: 100%;" id="seirparent">
                <div class="column" style="min-width: 220px;max-width: 15%;" id="seirdata"></div>
                <div class="column" style="flex: 1;flex-grow: 1;" id="seirplot"> </div>
            </div>

        </div>
    </div>
    <!-- END of SEIR plot-->



    <!-- Description -->
    <div class="row">
        <div class="column fullwidth" style="padding-bottom: 25px;">
            <div class="MinorTitleColumn">Description</div>
            <div class="notestext" style="font-size: 18px;">
                <p>
                    This page presents reported COVID-19 diagnoses and related deaths by country
                    and US state. The data is then fit to a standard SEIR (<strong>S</strong>usceptible,
                    <strong>E</strong>xposed, <strong>I</strong>nfectious, <strong>R</strong>emoved) model. Note that
                    the
                    fitting application is
                    not yet complete, but overlay of SEIR
                    model to data ca be manually performed.
                </p>
                <br>
                <br>
                <p>
                    <br>
                    4/25/2020 <strong>Still to Complete:</strong>
                    <br>
                    1. Update SEIR color scheme (its terrible)
                    <br>
                    2. Complete Documentation below
                </p>

                <br><br>

                The SEIR model categorizes a population according to the following:
                <br><br>
                <div id="seirstatetable" style="padding-left: 30px;"></div>
                <div style="padding-bottom: 20px;"></div>
                The model includes the following tunable paramaters:
                <br><br>
                <div id="seirparamtable" style="padding-left: 30px;"></div>
                <div style="padding-bottom: 20px;"></div>
                The model evolves according to the following set of differential equations:
                <div style="padding-top: 20px;">
                    <tspan style="font-style: italic">To do: Add documentation for differential
                        equations</tspan>
                </div>


            </div>
        </div>
    </div>

    <!-- Notes Block -->
    <div class="row">
        <div class="column fullwidth">
            <div class="MinorTitleColumn">Notes</div>
            <div class="notestext">
                Data source: Johns Hopkins Coronavirus Research Center: <a
                    href="https://github.com/CSSEGISandData/COVID-19">https://github.com/CSSEGISandData/COVID-19</a>
            </div>
            <div id="author" class="notestext">
                <table class="notestext" sytle="border-top: 10px;">
                    <tr>
                        <td align="right">Author:</td>
                        <td>Steven Michael <a href="mailto:ssmichael@gmail.com">ssmichael@gmail.com</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><a href="https://github.com/StevenSamirMichael/">https://github.com/StevenSamirMichael/</a>
                        </td>
                    </tr>
                    <tr>
                        <td align="right" height="50px">Inspred By:</td>
                        <td><a href="https://gabgoh.github.io/COVID/">https://gabgoh.github.io/COVID/</a>
                        </td>
                    </tr>
                    <tr>
                        <td align="right" height="50px">Source Code:</td>
                        <td><a
                                href="https://github.com/StevenSamirMichael/SEIR">https://github.com/StevenSamirMichael/SEIR/</a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</body>

<script src="/js/d3/dist/d3.min.js">
</script>
<script src="/js/moment/min/moment.min.js"></script>
<script src="/js/mathjax/es5/tex-mml-chtml.js"></script>
<script src="/js/d3-simple-slider/dist/d3-simple-slider.min.js"></script>
<script>
    function LightenDarkenColor(col, amt) {

        var usePound = false;

        if (col[0] == "#") {
            col = col.slice(1);
            usePound = true;
        }

        var num = parseInt(col, 16);

        var r = (num >> 16) + amt;

        if (r > 255) r = 255;
        else if (r < 0) r = 0;

        var b = ((num >> 8) & 0x00FF) + amt;

        if (b > 255) b = 255;
        else if (b < 0) b = 0;

        var g = (num & 0x0000FF) + amt;

        if (g > 255) g = 255;
        else if (g < 0) g = 0;

        return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16);

    }
</script>

<!-- <script src="/seirplot.js"></script>-->
<script>
    // Set some globals
    var seirinput = {
        R0: 2.8,
        Tinc: 2.5,
        Tinf: 5,
        Thos: 5,
        Tmrec: 12,
        Threc: 12,
        Tfat: 5,
        pMild: 0.8,
        pFatal: 0.01,
        duration: 200,
        population: 30000,
        dt: 1,
        Tintervention: 100,
        intervention_duration: 200,
        R0_reduction: 0.67,
        Hc: 0.01,
        pfat_increase_nohos: 1.0,
        startdate: 0
    };
    var runtime_initialized = false

    var plot_deltas = false
    var overlay_model = false

    var currentData = null
    var dataplot = {}
    var plot1 = {}
    var plot2 = {}
    var seirdata = null
    var mindate = moment([2020, 2, 1]);


    dataplot.plot_width = 500
    dataplot.plot_height = 320
    plot1.svg = d3.select("#deaths_plot")
        .attr("width", dataplot.plot_width)
        .append("svg")
        .attr("width", dataplot.plot_width)
        .attr("height", dataplot.plot_height)
    //.attr('viewBox', '0 0 '+ width * 1.1 + ' ' + height * 1.2)
    //.attr('preserveAspectRatio', 'xMinYMin');
    dataplot.margin = {
        top: 20,
        right: 30,
        bottom: 30,
        left: 50
    };
    dataplot.width = +plot1.svg.attr("width") - dataplot.margin.left - dataplot.margin.right
    dataplot.height = +plot1.svg.attr("height") - dataplot.margin.top - dataplot.margin.bottom;

    // Main group holding the deaths plot
    plot1.g = plot1.svg.append("g")
        .attr("transform", "translate(" + dataplot.margin.left + "," + dataplot.margin.top + ")")
        .attr("width", dataplot.width)
        .attr("height", dataplot.height);


    // SVG for the confirmed cases plot
    plot2.svg = d3.select("#cases_plot").append("svg")
        .attr("width", dataplot.plot_width)
        .attr("height", dataplot.plot_height)

    // Main group holding the confirmed cases plot
    plot2.g = plot2.svg.append("g").attr("transform",
        "translate(" + dataplot.margin.left + "," + dataplot.margin.top + ")");




    // Get a list of states
    var baseurl = window.location.origin;
    d3.json(baseurl + "/data/statelist").then(function (stateslist) {
        let s = d3.select("#states")
            .insert("select")

        s
            .attr("id", "states_dropdown")
            .attr("disabled", true)
            .selectAll("option")
            .data(stateslist)
            .enter()
            .append("option")
            .attr("value", d => d)
            .text(d => d)
        s.on("change", () => {
            UpdatePlotState(s.property("value"))
        });

    });
    d3.json(baseurl + "/data/countrylist").then(function (countrylist) {
        let s = d3.select("#countries")
            .insert("select")

        s
            .attr("id", "countries_dropdown")
            .selectAll("option")
            .data(countrylist)
            .enter()
            .append("option")
            .attr("value", d => d)
            .text(d => d);
        s.on("change", () => {
            UpdatePlotCountry(s.property("value"))
        });
    });



    d3.selectAll("input[name='sourcetype']").on("change", function (d) {
        cntry = d3.selectAll("#countries_dropdown");
        states = d3.selectAll("#states_dropdown");
        if (this.value == "radio_states") {
            cntry.attr("disabled", true)
            states.attr("disabled", null)
            UpdatePlotState(states.property("value"))
        }
        else if (this.value == "radio_country") {
            cntry.attr("disabled", null)
            states.attr("disabled", true)
            UpdatePlotCountry(cntry.property("value"))
        }
    });

    function UpdatePlotState(statename) {
        d3.json(baseurl + "/data/state/" + statename).then(d => {
            currentData = d
            updatePlots(d)
        });
    }
    function UpdatePlotCountry(countryname) {
        d3.json(baseurl + "/data/country/" + countryname).then(d => {
            currentData = d
            updatePlots(d)
        }
        )
    }

    d3.selectAll("input[name='plot_deltas']").on("click", () => {
        plot_deltas = d3.selectAll("input[name='plot_deltas']").property("checked")
        updatePlots(currentData)
    })
    d3.selectAll("input[name='overlay_model']").on("click", () => {
        overlay_model = d3.selectAll("input[name='overlay_model']").property("checked")
        updatePlots(currentData)
    })

    function draw_model_overlay(g, fieldname) {

        let date0 = moment([2020]).utc().add(seirinput.startdate, 'day')
        let maxdate = moment(currentData.series[currentData.series.length - 1].date).add(1, 'days')

        overlaydata =
            seirdata
                .map((d, i, a) => {
                    yp = 0
                    if (plot_deltas) {
                        yp = 0
                        if (i > 0) {
                            yp = (a[i][fieldname] - a[i - 1][fieldname]) /
                                (a[i].time - a[i - 1].time)
                        }
                    }
                    else {
                        yp = d[fieldname]
                    }
                    xp = date0.clone().add(d.time, 'day')
                    return {
                        x: xp,
                        y: yp
                    }
                })
                .filter(d => ((d.x > mindate) && (d.x <= maxdate)))


        const area = d3.area()
            .x(d => dataplot.x(d.x))
            .y1(d => dataplot.y(d3.max([d3.min([d.y, dataplot.y.domain()[1] - 1]), 0])))
            .y0(dataplot.height)

        g.selectAll(".seirarea")
            .remove()

        g.selectAll("#seirareagroup")
            .append("path")
            .data([overlaydata])
            .classed("seirarea", true)
            .attr("d", area)

    }


    function updatePlots(data) {
        updatePlot(plot1.g, plot2.g, data, "COVID-19 Related Deaths", "deaths");
        updatePlot(plot2.g, plot1.g, data, "COVID-19 Confirmed Cases", "confirmed")
        d3.select("#namefield").text(d3.format(",")(data.population))
        d3.select("#deathsfield").html("&#8721<br>&#x394")
        d3.select("#casesfield").html("&#8721<br>&#x394")
        if (seirinput.population != data.population) {
            seirinput.population = data.population
            d3.select("#seir-population-text")
                .html("Population: " + d3.format(",")(data.population))
            update_seir()
        }
        if (overlay_model) {
            draw_model_overlay(plot1.g, "fatal")
            draw_model_overlay(plot2.g, "infectious")
        }

    }

    function updatePlot(grp, grp2, alldata, titlestring, fieldname) {
        // re-draw plot
        grp.selectAll('*').remove();

        let name = alldata['name'];
        let data = alldata['series'];

        // Add this group since we want seir bars to be
        // in the background
        grp.append("g").attr("id", "seirareagroup")

        // Remove data before March 1
        // (months are zero based in moment)
        data = data.filter(d => { return (moment(d.date) > mindate); });

        let plotdata = data
        title2 = 'Cumulative'
        if (plot_deltas) {
            plotdata = plotdata.map((d, i, arr) => {
                let y = 0
                if (i > 0) {
                    y = arr[i][fieldname] - arr[i - 1][fieldname]
                }
                let r = {
                    date: d.date,
                }
                r[fieldname] = y
                return r
            })
            title2 = 'Daily Change'
        }
        dataplot.y = d3.scaleLinear()
            .rangeRound([dataplot.height, 0]);
        dataplot.x = d3.scaleLinear()
            .range([0, dataplot.width])
            .domain([mindate, moment(data[data.length - 1].date)])
        dataplot.y.domain([0, d3.max(plotdata, function (d) {
            return d[fieldname];
        })]);


        // gridlines in y axis function
        function make_y_gridlines() {
            return d3.axisLeft(dataplot.y)
                .ticks(10)
        }

        // add the Y gridlines
        grp.append("g")
            .attr("class", "grid")
            .call(make_y_gridlines()
                .tickSize(-dataplot.width)
                .tickFormat("")
            )
        grp.append("g")
            .attr("transform", "translate(0," + dataplot.height + ")")
            .attr("class", "axis")
            .call(d3.axisBottom(dataplot.x)
                .tickFormat(d => { return (d.utc().get("month") + 1) + "/" + (d.utc().get("date")) })
                .tickValues(data.map(d => moment(d.date)).filter(d => !(d.dayOfYear() % 7))))

        yaxis = grp.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(dataplot.y).ticks(null, "s"))

        yaxis
            .append("text")
            .attr("class", "axis-label")
            //.attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("dx", "1.0em")
            .attr("text-anchor", "start")
            .text(titlestring)
        yaxis
            .append("text")
            .attr("class", "axis-label")
            .attr("y", 6)
            .attr("dy", "1.75em")
            .attr("dx", "1.0em")
            .attr("text-anchor", "start")
            .text(title2);
        namelabel = yaxis
            .append("text")
            .attr("class", "axis-label")
            .attr("y", 6)
            .attr("dy", "3.2em")
            .attr("dx", "1.0em")
            .attr("text-anchor", "start")
            .text("Alabama");


        let bwidth = dataplot.x(mindate.clone().add(1, 'day'))
        let boffset = 0
        if (overlay_model) {
            bwidth = bwidth * .6
            boffset = 0.2 * bwidth
        }
        else {
            boffset = bwidth * .08
            bwidth = bwidth * .84
        }
        grp.selectAll(".bar")
            .data(plotdata)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("date", function (d) { return d.date; })
            .attr("x", function (d) {
                return dataplot.x(moment(d.date) + boffset);
            })
            .attr("y", function (d) {
                return dataplot.y(d[fieldname]);
            })
            .attr("width", bwidth)
            .attr("height", function (d) {
                return dataplot.height - dataplot.y(Number(d[fieldname]));
            })
            .on("mouseover", function (d, i) {
                d3.select(this).attr("myhover", true);

                // Highlight same date in other plot
                grp2.selectAll(".bar")
                    .filter(function (d2) {
                        return (d2.date == d.date);
                    })
                    .attr("myhover", true);
                let deltaDeaths = 0;
                let deltaConfirmed = 0;
                if (i > 0) {
                    deltaDeaths = data[i].deaths - data[i - 1].deaths;
                    deltaConfirmed = data[i].confirmed - data[i - 1].confirmed;
                }


                // Update statistics text
                let dm = moment.utc(d.date);

                d3.select("#deathsdate").html(String(dm.utc().month() + 1).padStart(2, '0') + "/" + String(dm.utc().date()).padStart(2, '0'));
                d3.select("#deathsfield").html("&#8721  " + d3.format(",")(data[i].deaths) +
                    "  ( " + (data[i].deaths / alldata.population * 100.0).toPrecision(2) + "% )" + "<br>&#x394 " +
                    d3.format(",")(deltaDeaths))
                d3.select("#casesfield").html("&#8721  " + d3.format(",")(data[i].confirmed) + "  ( " + (data[i].confirmed / alldata.population * 100.0).toPrecision(2) + "% )"
                    + "<br>&#x394 " + d3.format(",")(deltaConfirmed))
            })
            .on("mouseout", function (d) {
                d3.select(this).attr("myhover", null);


                // Highlight same date in other plot
                grp2.selectAll(".bar")
                    .filter(function (d2) {
                        return (d2.date == d.date);
                    })
                    .attr("myhover", null);
            });
        namelabel.text(name);
    };
    // Default
    UpdatePlotCountry("United States")

</script>


<script>
    // Keys to plot
    var allkeys = ["fatal", "hospitalized", "mild", "infectious", "exposed", "removed"]
    var plotkeys = ["fatal", "hospitalized", "mild", "infectious", "exposed"]

    let seircolors = ['#DA5319', '#0072BE', '#77AD30', '#EEB220', '#7E2F8E', '#888888']

    var z = d3.scaleOrdinal()
        .range(seircolors.map(d => LightenDarkenColor(d, 40)))

    var zhighlight = d3.scaleOrdinal()
        .range(seircolors)
        .domain(allkeys)

    var update_running = false

    function resizeSeir() {

        seirplot.plot_width = d3.select("#seirparent").node().getBoundingClientRect().width -
            d3.select("#seirdata").node().getBoundingClientRect().width - 50
        seirplot.plot_height = d3.max([560, seirplot.plot_width / 2])
        seirplot.margin = {
            top: 60,
            right: 30,
            bottom: 30,
            left: 50
        };
        seirplot.width = seirplot.plot_width - seirplot.margin.left - seirplot.margin.right
        seirplot.height = seirplot.plot_height - seirplot.margin.top - seirplot.margin.bottom;

        d3.selectAll("#seirplotsvg").remove()
        d3.select("#seirplot")
            .append("svg")
            .attr("width", seirplot.plot_width)
            .attr("height", seirplot.plot_height)
            .attr("id", "seirplotsvg")
            .append("g")
            .attr("id", "seirplotarea")
            .attr("transform", "translate(" + seirplot.margin.left + "," + seirplot.margin.top + ")")
            .attr("width", seirplot.width)
            .attr("height", seirplot.height)


        d3.selectAll("#seirplotarea")
            .append("g")
            .classed("bggroup", true)
            .append("rect")
            .classed("bgrect", true)

        d3.selectAll("#seirplotarea")
            .append("g")
            .attr("transform", "translate(0," + seirplot.height + ")")
            .attr("class", "x-axis")

        d3.selectAll("#seirplotarea")
            .append("g")
            .attr("class", "y-axis")

    }
    resizeSeir()

    function update_seir() {
        let keys = allkeys.filter(d => { return plotkeys.includes(d) })

        if (!runtime_initialized)
            return
        if (update_running == true)
            return;
        update_running = true



        raw = Module.seir(seirinput)

        if (!raw) {
            return
        }
        dmap = undefined
        // Reformat data to accommodate plotting
        let datagen = function* (raw) {
            i = 0;
            // Leave out last point to get nice round number for # of points
            // (i.e., 200 instead of 201)
            while (i < raw.size() - 1) {
                r = {
                    time: raw.get(i).get(8),
                    exposed: d3.max([raw.get(i).get(1), 0]),
                    infectious: d3.max([raw.get(i).get(2), 0]),
                    mild: d3.max([raw.get(i).get(3), 0]),
                    hospitalized: d3.max([raw.get(i).get(4) + raw.get(i).get(5), 0]),
                    fatal: d3.max([raw.get(i).get(6), 0]),
                    removed: d3.max([raw.get(i).get(7), 0])
                };
                yield r;
                i++;
            }
        };
        let data = Array.from(datagen(raw))
        raw = undefined
        seirdata = data
        // Get maximum value on y axis

        let x = d3.scaleLinear()
            .range([0, seirplot.width])
            .domain([0, seirinput.duration])
        let y = d3.scaleLinear()
            .rangeRound([seirplot.height, 0])
            .domain([0, d3.max(data, d => d3.sum(keys, k => +d[k]))]).nice()

        let pointsToPlot = 200;
        let skip = Math.ceil(data.length / pointsToPlot)

        let svg = d3.selectAll("#seirplotarea")

        date0 = moment([2020]).utc().add(seirinput.startdate, 'day')

        svg.selectAll(".x-axis")
            .call(d3.axisBottom(x).tickSizeOuter(0)
                .ticks(10)
                .tickFormat(d => {
                    tickdate = date0.clone().add(d, 'day')
                    return (tickdate.utc().get("month") + 1) + "/" + (tickdate.utc().get("date") + "/" + (tickdate.utc().get("year") - 2000))
                })
            )

        // Create axes
        svg.selectAll(".y-axis")
            .call(d3.axisLeft(y).ticks(null, "s"))
        svg.selectAll(".y-axis")
            .append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(y)
                .ticks(null, "s")
                .tickSize(-seirplot.width)
                .tickFormat("")
            )

        let barnames = ["exposed", "infectious", "mild", "hospitalized", "fatal", "removed"]

        if (seirinput.R0_reduction > 0) {
            bgrect = svg.selectAll(".bgrect")

            let bgwidth = d3.min([seirinput.intervention_duration, seirinput.duration - seirinput.Tintervention])
            bgrect.classed("intervention-rect", true)
                .attr("x", x(seirinput.Tintervention))
                .attr("width", x(seirinput.Tintervention + bgwidth) - x(seirinput.Tintervention))
                .attr("y", 0)
                .attr("height", seirplot.height)
                .attr("visibility", "visible")
            let bg = ["Intervention Period", d3.format("d")(seirinput.R0_reduction * 100) + "% Reduction"]


            let bgtext = svg.selectAll(".bggroup").selectAll("text").data(bg)
            bgtext.enter().append("text")
                .merge(bgtext)
                .attr("x", x(seirinput.Tintervention + bgwidth) - 10)
                .attr("y", (d, i) => i * 16)
                .attr("dy", "1em")
                .attr("text-anchor", "end")
                .attr("visibility", "visible")
                .classed("intervention-label", true)
                .html(d => d)
            bgtext.attr("visibility", "visible")
        }
        else {
            bgrect = svg.selectAll(".bgrect")
            bgrect.attr("visibility", "hidden")
            let bgtext = svg.selectAll(".bggroup").selectAll("text")
            bgtext.attr("visibility", "hidden")
        }

        let group = svg.selectAll("g.layer")
            .data(d3.stack().keys(keys)(data), d => d.key)
        group.exit().remove()

        group.enter().append("g")
            .classed("layer", true)
            .attr("plotname", d => d.key)
            .attr("fill", d => z(d.key))
            .attr("id", function (d) { return d.key })

        let bars = svg.selectAll("g.layer").selectAll("rect")
            .data(d => d.filter((d, i) => !(i % skip)))

        bars.exit().remove()

        let bwidth = x(seirinput.dt * skip) - x(0)
        let boffset = bwidth * .1
        bwidth = bwidth * .8
        bars.enter().append("rect")
            .attr("width", bwidth)
            .merge(bars)
            .attr("class", function (d, i) { return "vidx" + i; })
            .classed("seirbar", true)
            .attr("x", d => x(d.data.time) + boffset)
            .attr("y", d => y(d[1]))
            .attr("height", d => y(d[0]) - y(d[1]))
            .on("mouseover", function (d, i) {
                keys.forEach(k => {
                    svg.selectAll("#" + k).selectAll("rect.vidx" + i).attr("fill", zhighlight(k))
                })
                d3.selectAll("#seir-day-text").html("Day: " + d.data.time)

                let index = data.findIndex(dd => { return (dd.time == d.data.time) })
                barnames.forEach(name => {
                    let sumval = data[index][name]
                    let diffval = 0
                    if (index > 0)
                        diffval = data[index][name] - data[index - 1][name]
                    ptext = d3.format(".2%")(sumval / seirinput.population)
                    d3.select("#" + name + "-text")
                        .html("&#8721 " + d3.format(',')(Math.floor(sumval)) + " ( " + ptext + " )"
                            + "<br> &#x394 " + d3.format(',')(Math.floor(diffval)))
                })
            })
            .on("mouseout", function (d, i) {
                keys.forEach(k => {
                    svg.selectAll("#" + k).selectAll("rect.vidx" + i).attr("fill", z(k))
                })

            })

        d3.selectAll("#hospital-capacity-text")
            .html("Hospital Capacity: " + d3.format(",")(Math.floor(seirinput.population * seirinput.Hc)))

        if (overlay_model) {
            draw_model_overlay(plot1.g, "fatal")
            draw_model_overlay(plot2.g, "infectious")
        }
        update_running = false

    } // end of update_seir





    function create_slider(at, range, val, format, field, step) {

        slider = d3
            .sliderBottom()
            .min(range[0])
            .max(range[1])
            .width(170)
            .ticks(5)
            .default(val)
            .tickFormat(d3.format(format))
            .on('onchange', value => {
                seirinput[field] = value
                update_seir()
            })
        if (!(step == undefined)) {
            slider.step(step)
        }

        at
            .append("svg")
            //.attr("width", 200)
            .attr("height", 64)
            .append("g")
            .attr("transform", "translate(20,20)")
            .attr("class", "seir-slider")
            .attr("id", "slider_" + field)
            .call(slider)
    }

    plot_params = [
        {
            name: "Exposed",
            label: "\\(\\mathcal{E}xposed\\)",
            fieldname: "exposed"
        },
        {
            name: "Infectious",
            label: "\\(\\mathcal{I}nfectious\\)",
            fieldname: "infectious"
        },
        {
            name: "Mild",
            label: "\\(\\mathcal{M}ild\\)",
            fieldname: "mild"
        },
        {
            name: "Hospitalized",
            label: "\\(\\mathcal{H}ospitalized\\)",
            fieldname: "hospitalized"
        },
        {
            name: "Fatal",
            label: "\\(\\mathcal{F}atal\\)",
            fieldname: "fatal"
        },
        {
            name: "Removed",
            label: "\\(\\mathcal{R}emoved\\)",
            fieldname: "removed"
        }
    ]
    d3.selectAll("#seirdata")
        .append("div")
        .classed("row", true)
        .append("div")
        .classed("column", true)
        .html("Population: ")
        .attr("style", "padding-bottom: 10px;padding-top: 20px;")
        .attr("id", "seir-population-text")

    d3.selectAll("#seirdata")
        .append("div")
        .classed("row", true)
        .append("div")
        .classed("column", true)
        .html("Hospital Capacity: ")
        .attr("style", "padding-bottom: 10px;")
        .attr("id", "hospital-capacity-text")

    d3.selectAll("#seirdata")
        .append("div")
        .classed("row", true)
        .append("div")
        .classed("column", true)
        .html("Day: ")
        .attr("style", "padding-bottom: 10px;")
        .attr("id", "seir-day-text")

    plot_params.forEach(param => {
        let row = d3.selectAll("#seirdata")
            .append("div")
            .attr("class", "row")
            .attr("style", "padding-top: 10px;")

        row.append("div")
            .attr("class", "row")
            .append("div")
            .attr("class", "column")
            .attr("style", "padding-bottom: 10px;")
            .call(d => d
                .append("input")
                .attr("type", "checkbox")
                .attr("id", "check_" + param.fieldname)
                .attr("checked", () => {
                    if (plotkeys.includes(param.fieldname)) { return true }
                    return null
                })
                .on("click", d => {
                    let checked = d3.selectAll("#check_" + param.fieldname).property("checked")
                    if (!checked) {
                        const index = plotkeys.indexOf(param.fieldname)
                        if (index > -1) {
                            plotkeys.splice(index, 1)
                        }
                    }
                    else
                        plotkeys.push(param.fieldname)
                    update_seir()
                })
            )
            .call(d => d.append("label")
                .attr("style", "color: " + zhighlight(param.fieldname) + ";")
                .html(param.label))
        row.append("div")
            .classed("row", true)
            .append("div")
            .classed("column", true)
            .attr("style", "height: 40px;")
            .append("text")
            .attr("id", param.fieldname + "-text")
            .attr("style", "color: " + zhighlight(param.fieldname) + ";")
            .html("&#8721 <br> &#x394")

    })


    model_params = [
        {
            title: "Infection Parameters",
            width: "25%",
            cosl: 1,
            values: [[{
                label: "\\(\\mathcal{R}_0\\)",
                args: [[1, 8], seirinput.R0, ".3", "R0"]
            }],
            [{
                label: "\\(p_{mild}\\)",
                args: [[0, 1], seirinput.pMild, ".3", "pMild"]
            }],
            [{
                label: "\\(p_{fatal}\\)",
                args: [[0, 0.05], seirinput.pFatal, ".2%", "pFatal"]
            },
            {
                label: "\\(\\Delta p_{fatal}\\) \\(| \\mathcal{H} > \\mathcal{C}_\\mathcal{H}\\)",
                args: [[0, 5], seirinput.pfat_increase_nohos, ".0%", "pfat_increase_nohos"]
            },
            ]]
        },
        {
            title: "Time Constants",
            width: "45%",
            cols: 2,
            values: [[
                {
                    label: "\\(\\mathcal{T}_{inc}\\)",
                    args: [[1, 14], seirinput.Tinc, 'd', "Tinc"]
                },
                {
                    label: "\\(\\mathcal{T}_{inf}\\)",
                    args: [[5, 28], seirinput.Tinf, 'd', "Tinf"]
                },

                {
                    label: "\\(\\Delta_{sim}\\)",
                    args: [[200, 1000], seirinput.duration, "d", "duration", 200]
                },
                {
                    label: "\\(T_{start}\\)",
                    args: [[-60, 60], seirinput.startdate, "d", "startdate", 1]
                }
            ],
            [
                {
                    label: "\\(\\mathcal{T}_{mrec}\\)",
                    args: [[1, 21], seirinput.Tmrec, 'd', "Tmrec"]
                },
                {
                    label: "\\(\\mathcal{T}_{hrec}\\)",
                    args: [[1, 21], seirinput.Threc, 'd', "Threc"]
                },
                {
                    label: "\\(\\mathcal{T}_{fatal}\\)",
                    args: [[5, 28], seirinput.Tfat, 'd', "Tfat"]
                },
            ]]
        },
        {
            title: "Intervention",
            width: "25%",
            cols: 1,
            values: [[
                {
                    label: "\\(T_{int}\\)",
                    args: [[0, 200], seirinput.Tintervention, 'd', "Tintervention"]
                },
                {
                    label: "\\(\\Delta \\mathcal{R}_0\\)",
                    args: [[0, 1], seirinput.R0_reduction, '.0%', "R0_reduction"]
                },
                {
                    label: "\\(\\Delta_{int}\\)",
                    args: [[0, 200], seirinput.intervention_duration, 'd', "intervention_duration"]
                },
                {
                    label: "\\(\\mathcal{C}_\\mathcal{H}\\)",
                    args: [[.001, .02], seirinput.Hc, '.2%', "Hc"]
                }
            ]]
        }
    ]

    let pdiv = d3.select("#modelparams")
        .attr("style", "padding-bottom: 20px;")
        .append("div")
        .attr("class", "row")

    model_params.forEach(paramcol => {
        let pcol = pdiv.append("div")
            .attr("style", "width: " + paramcol.width + ";")
            .attr("class", "column")
        pcol.append("div")
            .attr("class", "paramcolumn")
            .html(paramcol.title)

        let subrow = pcol.append("div")
            .attr("class", "row")

        paramcol.values.forEach(prow => {
            subcol_length = Math.floor(100 / paramcol.cols)
            let subcol = subrow
                .append("div")
                .attr("style", "width: " + subcol_length + "%;")
                .attr("class", "column")

            let paramrow = subcol.append("div")
                .attr("class", "row")

            prow.forEach(pcol => {
                paramrow.append("div")
                    .attr("class", "column")
                    .attr("style", "align: right;text-align: right;padding-top: 10px;width: 15%;color: slategray;")
                    .html(pcol.label)
                paramrow.append("div")
                    .attr("class", "column")
                    .attr("style", "width: 80%;")
                    .call(create_slider, pcol.args[0], pcol.args[1], pcol.args[2], pcol.args[3], pcol.args[4])

            })
        })
    })

</script>

<script>
    function paramtable(g, tdata, fcwidth = 60) {
        tdata.forEach(rowdata => {
            rdiv = g.append("div")
                .classed("row", true)
                .attr("style", "padding-bottom: 15px;")
            firstcol = true
            rowdata.forEach(col => {
                cdiv = rdiv.append("div")
                    .classed("column", true)
                    .html(col)
                if (firstcol) {
                    cdiv.attr("style", "text-align: right;width: " + fcwidth + "px;")
                    firstcol = false
                }
                else {
                    cdiv.attr("style", "text-align: left;")
                }
            })
        })
    }

    seirstatedata = [
        ["\\(\\mathcal{S}\\):", "<strong>Susceptible</strong><br>Population susceptible to exposure, i.e. " +
            "not immune from previous exposure.  Initially assumed to be 100%"
        ],
        ["\\(\\mathcal{E}\\):", "<strong>Exposed</strong><br>Population eposed to virus. " +
            "Not yet symptomatic or infectious, but becoming infectious with 100% probability"
        ],
        ["\\(\\mathcal{I}\\):", "<strong>Infectious</strong><br>Population infectious after becoming " +
            "exposed.  Will infect susceptible populatinon according to reproduction number \\(\\mathcal{R}_0\\)"
        ],
        ["\\(\\mathcal{M}\\):", "<strong>Mild</strong><br>Mildly symptomatic population.  No longer " +
            "infectious.  May be asymptomatic.  Not hospitalized"
        ],
        ["\\(\\mathcal{H}\\):", "<strong>Hospitalized</strong><br>Hospitalized population.  No lonter " +
            "infectious."
        ],
        ["\\(\\mathcal{F}\\):", "<strong>Fatal</strong><br>Population that has died due to virus"],
        ["\\(\\mathcal{R}\\):", "<strong>Removed</strong><br>Population recovered from virus " +
            "and no longer susceptible"]
    ]
    seirparamtabledata = [
        ["\\(\\mathcal{R}_0\\) :", "<strong>Reproduction Number.</strong><br>The average number"
            + " of people an infectious person will cause to be exposed, given a fully-susceptible poulation"],
        ["\\(p_{mild}\\) :", "<strong>Mild Probability</strong><br>Probability that an exposed " +
            "person will be asymptomatic or expeirience mild symptoms that do not require hospitalization"],
        ["\\(\\mathcal{C}_{\\mathcal{H}}\\) :", "<strong>Hospital Capacity</strong><br>" +
            "Hospital capacity, as percentage of population"],
        ["\\(p_{fatal}\\) :", "<strong>Fatal Probability</strong><br>" +
            "Probability of death given exposure"],
        ["\\(\\Delta p_{fatal}\\) \\(| \\mathcal{H} > \\mathcal{C}_\\mathcal{H}\\)",
            "<strong>Fatal Probability Increase</strong><br>" +
            "Increase in fatal probability as percentage if hospitalizations exceed hospital capacity"],
        ["\\(\\mathcal{T}_{inc}\\) :", "<strong>Incubation Period</strong><br>" +
            "Period in days between exposure and person becoming infectious"],
        ["\\(\\mathcal{T}_{inf}\\) :", "<strong>Infectious Period</strong><br>" +
            "Average period in days that a person is infectious"],
        ["\\(\\mathcal{T}_{mrec}\\) :", "<strong>Mild Recovery Period</strong><br>" +
            "Average period in days for a person to recover from mild symptoms"],
        ["\\(\\mathcal{T}_{hrec}\\) :", "<strong>Hospital Recovery Period</strong><br>" +
            "Average period in days for a person to recover if hospitalized"],
        ["\\(\\mathcal{T}_{fatal}\\) :", "<strong>Fatal period</strong><br>" +
            "Average period in days a person with a fatal outcome will stay in hospital"],
        ["\\(T_{int}\\) :", "<strong>Intervention Start</strong><br>" +
            "Start of intervention period in which \\mathcal{R}_0 is reduced"],
        ["\\(\\Delta_{int}\\) :", "<strong>Intervention Duration</strong><br>" +
            "Length in days of intervention period"],
        ["\\(\\Delta \\mathcal{R}_0\\) :", "<strong>Reproduction Number Reduction</strong><br>" +
            "During intervention period, reduction in reproduction number as percentage"],
        ["\\(\\Delta_{sim}\\) :", "<strong>Simulation Duration</strong><br>" +
            "Simulation duration, in days"],
        ["\\(T_{start}\\) :", "<strong>Simulation Start</strong><br>" +
            "Simulation start shift in days, relative to Jan. 1 2020.  Used to when" +
            " overlaying model data onto reported statistics"]


    ]
    paramtable(d3.selectAll("#seirstatetable"), seirstatedata)
    paramtable(d3.selectAll("#seirparamtable"), seirparamtabledata, 100)
</script>

<script>
    MathJax.typeset()

    window.addEventListener("resize", () => {
        resizeSeir()
        update_seir()
    })

</script>


<script>
    var Module = {
        onRuntimeInitialized: function () {
            runtime_initialized = true
            update_seir()
        }
    }
</script>
<script src="/customjs/seirmodel4.js"></script>




</html>